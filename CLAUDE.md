# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AquaData — a full-stack aquaculture farm management MVP. Spanish-language UI for field operators to digitize handwritten production reports via AI-powered OCR, track pond/batch data, view analytics, and calculate bioremediation doses.

## Commands

```bash
pnpm install          # Install dependencies (pnpm is the package manager)
pnpm dev              # Dev server on http://localhost:3000
pnpm build            # Production build (TS errors are ignored via next.config.mjs)
pnpm start            # Start production server
pnpm lint             # ESLint
```

No test framework is configured.

## Tech Stack

- **Framework:** Next.js 16 (App Router) with React 19, TypeScript
- **Styling:** Tailwind CSS 3 + shadcn/ui (50+ Radix-based components in `components/ui/`)
- **Database/Auth:** Supabase (PostgreSQL + Auth + RLS)
- **AI:** Vercel AI SDK (`ai` package) with provider factory pattern
- **Charts:** Recharts
- **Forms:** React Hook Form + Zod validation

## Architecture

### Routing & Auth Flow

Next.js App Router under `app/`. Middleware (`middleware.ts` → `lib/supabase/proxy.ts`) runs on every request to refresh the Supabase session. Unauthenticated users hitting `/dashboard/*` are redirected to `/auth/login`. Public routes: `/auth/*`, `/tools/*`, root `/`.

### Supabase Clients

Two separate client factories — never mix them:
- `lib/supabase/client.ts` — browser-side (used in `'use client'` components)
- `lib/supabase/server.ts` — server-side (used in Server Components and API routes)

Both read `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` from env.

### AI Provider Factory (`lib/ai/provider.ts`)

Centralizes model selection. Change `ACTIVE_PROVIDER` constant to switch between `anthropic` and `openai`. Models are referenced via Vercel AI Gateway format (`anthropic/claude-sonnet-4-20250514`). The OCR endpoint (`app/api/ocr/route.ts`) uses the vision model with Zod structured output.

### Database Schema

Defined in `scripts/001_create_schema.sql`. Multi-tenant via `organizations` table. Core chain: `organizations` → `ponds` → `batches` → `production_records`. RLS policies enforce organization-scoped access. User profiles auto-created on signup via DB trigger. Uploads and bioremediation_calcs are user-scoped.

Roles: `operario` (default), `admin`.

### Data Flow (OCR)

1. User uploads photo at `/dashboard/upload` (client component `components/upload-form.tsx`)
2. Base64 image sent to `POST /api/ocr`
3. Claude vision model returns structured JSON matching `productionDataSchema` (Zod) with per-field confidence scores
4. User reviews/edits extracted data, saves to `production_records`

### Component Patterns

- Server Components (async) for data fetching in `app/` page files
- Client Components (`'use client'`) for forms and interactivity in `components/`
- shadcn/ui components live in `components/ui/` — add new ones via `npx shadcn@latest add <name>`
- Path alias: `@/*` maps to project root

## Environment Variables

```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
ANTHROPIC_API_KEY=
OPENAI_API_KEY=           # optional, for OpenAI fallback
```

## Conventions

- UI text and AI prompts are in **Spanish**
- Dates from OCR are converted from DD/MM/YYYY to YYYY-MM-DD
- Tailwind theme uses CSS variables (HSL) with teal primary, defined in `app/globals.css`
- Dark mode via `class` strategy (next-themes)

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>